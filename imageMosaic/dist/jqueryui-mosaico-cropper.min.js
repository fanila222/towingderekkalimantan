/*! Mosaico Cropper - v0.9.0 - 2019-03-12
* Copyright (c) 2019 ; MIT license */

!function(Q){Q.widget("mosaico.mosaicoCropper",{options:{autoClose:!0,shiftWheel:!1},_init:function(){void 0!==this.options.instance&&this.options.instance.dispose(!0),this.options.instance=function(n,h,a){function d(i){return{width:Math.round(A.width*(i||K.scale)),height:Math.round(A.height*(i||K.scale))}}function l(){return void 0!==h.maxScale?h.maxScale:2}var e,c=!1,s=!1;function p(i){c&&clearTimeout(c),s||(X.addClass("cropper-moving"),X.addClass("cropper-moving-"+i),s=i)}function u(){c&&clearTimeout(c),s&&(X.removeClass("cropper-moving"),X.removeClass("cropper-moving-"+s),s=!1)}function g(i,e,t){return i<e?e:t<i?t:i}function f(i,e){K.crop.height=parseInt(i),void 0!==e&&(K.crop.width=parseInt(e),X.css({width:K.crop.width+"px"})),E.css({height:K.crop.height+"px",width:K.crop.width+"px"});var t=h.width/A.width,o=K.crop.height/A.height,r=Math.max(t,o);r!==K.minScale&&(K.minScale=r,_.slider({min:z(r)}))}function v(i,e,t,o,r){var n=!1;void 0!==t&&(n=function(i){{if(K.scale===i)return!1;K.scale=i;var e=d(),t={width:e.width+"px",height:e.height+"px"};return I.css(t),j.css(t),!0}}(t));var a=d();if(void 0!==i&&(i=g(i,K.crop.width-a.width,0),K.container.left!==i&&(K.container.left=i,n=!0)),void 0!==e&&(e=g(e,K.crop.height-a.height,0),K.container.top!==e&&(K.container.top=e,n=!0)),n){var c={left:K.container.left+"px",top:K.container.top+"px"};(void 0===o||o)&&j.css(c),I.css(c),t&&!1!==r&&_.slider("value",z(t))}return n}function m(){var i,e,t,o=d(i=K.minScale);return e=Math.round((K.crop.width-o.width)/2),t=Math.round((K.crop.height-o.height)/2),v(e,t,i)}function w(i,e,t,o){var r=d();if(null==e&&(e=(K.crop.width/2-K.container.left)/r.width),null==t&&(t=(K.crop.height/2-K.container.top)/r.height),(i=g(i,K.minScale,l()))===K.scale)return!1;var n=d(i),a=Math.round((n.width-r.width)*e),c=Math.round((n.height-r.height)*t),h=K.container.left-a,s=K.container.top-c;return v(h,s,i,void 0,o),!0}function M(i,e,t,o,r){if(!h.autoZoom&&r<e&&(e=r),f(e=Math.round(e)),"original"==i||"cover"==i||"resize"==i)m();else if(r<e){var n=e/A.height;w(n)}else{var a=Math.round((e-t)/2)+o;0<a&&(a=0),v(void 0,a)}}function C(i){var e=K.crop.height;return M(S().method,i,e,K.container.top,d().height),e!==K.crop.height}function x(){var i,e,t=m();t||(i=h.width/A.width,e=C(Math.round(A.height*i)),(t=e=w(i)||e)||w(1)),b()}function z(i){return Math.log(100*i)/Math.log(1.03)}function y(){var i=S();e!==i.method&&(X.removeClass("cropper-method-"+e),e=i.method,X.addClass("cropper-method-"+e))}function b(){y(),X.addClass("cropper-has-changes")}function S(){var i=d(),e=-K.container.left,t=i.width-K.crop.width+K.container.left,o=-K.container.top,r=i.height-K.crop.height+K.container.top,n={resizeWidth:i.width,resizeHeight:i.height,offsetX:Math.max(0,-K.container.left),offsetY:Math.max(0,-K.container.top),cropX:Math.max(0,Math.round(e/K.scale)),cropY:Math.max(0,Math.round(o/K.scale)),cropWidth:Math.round(K.crop.width/K.scale),cropHeight:Math.round(K.crop.height/K.scale),width:K.crop.width,height:K.crop.height};n.cropX2=n.cropX+n.cropWidth,n.cropY2=n.cropY+n.cropHeight;var a=Math.abs(e-t),c=Math.abs(o-r);return n.method=void 0!==h.resizeWidth?"resizecrop":"cropresize",a<=1&&c<=1&&(0===e||0===o)&&(n.method=0===e&&0===o?1!==K.scale?"resize":"original":"cover"),n}var o=["original","resize","cover","cropresize","resizecrop"];function r(){var i=S();i.urlPrefix=h.urlPrefix,i.urlPostfix=h.urlPostfix,i.urlOriginal=h.urlOriginal,i.encodedUrlOriginal=encodeURIComponent(h.urlOriginal);var e=h.urlAdapter.toSrc;if("object"==typeof e)for(var t=o.indexOf(i.method);t<o.length;t++)if(void 0!==e[o[t]]){e=e[o[t]];break}return"string"==typeof e&&(e=function(i,r){return i.replace(/\{([^[\}:]+)(?::[^\}]+)?\}/g,function(i,e,t,o){return r.hasOwnProperty(e)?void 0!==r[e]?r[e]:"":i})}.bind(void 0,e)),e(i)}function H(){F||(F=!0,function(t,e){try{var i=r();X.addClass("cropper-loading"),O(i,function(i,e){Q(n).attr("src",e),X.removeClass("cropper-loading"),t()},function(i){X.removeClass("cropper-loading"),X.addClass("cropper-has-changes"),e()}),X.removeClass("cropper-has-changes"),h.imgLoadingClass&&Q(n).removeClass(h.imgLoadingClass)}catch(i){console.error("Failed generating final URL",i),e()}}(t,function(){t(),F=!1}))}function t(i){if(!D){D=!0,G&&G.removeClass("cropper-cropping");try{E.resizable("destroy"),j.draggable("destroy"),_.slider("destroy")}catch(i){}X.remove(),h.imgLoadingClass&&Q(n).removeClass(h.imgLoadingClass),Q(n).css("display",$),i||void 0===a||a.destroy()}}function O(e,i,t){var o=new Image;o.onload=function(){i(o,e)},o.onerror=function(i){console.log("TODO img preload failed",i),t&&t(e)},o.src=e}var W={encodedUrlOriginal:"[^ &\\?]+",width:"[0-9]+",height:"[0-9]+",resizeWidth:"[0-9]+",resizeHeight:"[0-9]+",offsetX:"[0-9]+",offsetY:"[0-9]+",cropWidth:"[0-9]+",cropHeight:"[0-9]+",cropX:"[0-9]+",cropY:"[0-9]+",cropX2:"[0-9]+",cropY2:"[0-9]+"};function i(a,c,h){var s=[],i=new RegExp("^"+a.replace(/\\.|(\((?!\?[!:=]))|\{([^:\}]+)(?::([^\}]+))?\}/g,function(t,i,e,o,r,n){if(i)return s.push(""),t;if(e){if(s.push(e),o||(W[e]?o=W[e]:void 0!==c&&c[e]&&(o=c[e])),o)return o.replace(/\\.|(\((?!\?[!:=]))/g,function(i,e){return e&&s.push(""),t}),"("+o+")";throw console.error(a,h,c),"Uknown token "+e+", please use {"+e+":regex} or use a known pattern"}return t})+"$"),e=h.match(i),t=null;if(null!==e){e.length!==s.length+1&&console.log("ERROR parsing pattern!",a,s,e),t={};for(var o=0;o<s.length;o++)""!==s[o]&&void 0!==e[o+1]&&(t[s[o]]=e[o+1])}return t}var X=Q('<div class="mo-cropper cropper-hidden" tabindex="-1"><div class="cropper-frame"><div class="clipping-container"><div class="toolbar"><div class="tool tool-zoom"><i class="fa fa-compress" aria-hidden="true"></i></div><div class="copper-zoom-slider"></div><div class="tool tool-crop"><i class="fa fa-check" aria-hidden="true"></i></div></div><img draggable="false" class="clipped clipped-image original-src"></div><div class="clip-handle ui-resizable-s"></div></div><div class="outer-image-container"><img class="outer-image original-src"></div></div>');Q(n).after(X),h.imgLoadingClass&&Q(n).addClass(h.imgLoadingClass);var Y=h.urlAdapter.fromSrc;if("object"==typeof Y){var P=h.urlAdapter.toSrc,k=[];for(var L in P)P.hasOwnProperty(L)&&k.push(P[L].replace(/[.*+?^$()|[\]\\]/g,"\\$&"));var R="("+k.join("|")+")",T=Y;Y=i.bind(void 0,R,T)}"string"==typeof Y&&(Y=i.bind(void 0,Y,void 0));var U=Y(n.src);U?U.encodedUrlOriginal&&(U.urlOriginal=decodeURIComponent(U.encodedUrlOriginal)):void 0!==h.urlAdapter.defaultPrefix?(h.urlOriginal=n.src,h.urlPrefix=h.urlAdapter.defaultPrefix,h.urlPostfix=n.src):console.error("FAILED PARSING",n.src);Q.extend(h,U),h.width||(h.width=n.width,h.height=n.height);var A,I=X.find(".clipped"),E=X.find(".cropper-frame"),j=X.find(".outer-image-container"),_=X.find(".copper-zoom-slider"),$=Q(n).css("display"),D=!1,F=!1,G=!1;void 0!==h.containerSelector&&(G=Q(h.containerSelector));var K={container:{},crop:{}},N=h.urlOriginal||(h.urlPrefix||"")+(h.urlPostfix||"");N.match(/[a-z]+:/)||(N="http://"+N);return O(N,function(i,e){var t,o,r;X.find(".original-src").attr("src",e),A={width:i.naturalWidth,height:i.naturalHeight},G&&G.addClass("cropper-cropping"),!1!==h.autoClose&&X.focusout(function(i){null!=i.relatedTarget&&X.get(0).contains(i.relatedTarget)||void 0!==i.delegatedTarget||D||H()}),X.find(".tool-crop").on("click",function(){H()}),X.find(".tool-zoom").on("click",function(){x()}),X.focus(),function(){var i,e,t,o,r;if(void 0!==h.resizeWidth)o=h.resizeWidth/A.width,i=h.height,r=h.width,e=-h.offsetX,t=-h.offsetY;else if(void 0!==h.cropX2||void 0!==h.cropWidth)null==h.cropWidth&&(h.cropWidth=h.cropX2-h.cropX),null==h.cropHeight&&(h.cropHeight=h.cropY2-h.cropY),null==h.cropX&&(h.cropX=0),null==h.cropY&&(h.cropY=0),o=h.width/h.cropWidth,i=h.height||h.cropHeight*o,r=h.width,e=Math.round(-h.cropX*o),t=Math.round(-h.cropY*o);else if(void 0!==h.height){o=Math.max(h.width/A.width,h.height/A.height),r=Math.min(h.width,Math.round(A.width*o)),i=Math.min(h.height,Math.round(A.height*o));var n=d(o);e=Math.round((r-n.width)/2),t=Math.round((i-n.height)/2)}else h.width,o=h.width/A.width,i=Math.round(A.height*o),r=h.width,t=e=0;f(i,r),v(e,t,o),y()}(),E.resizable({minHeight:40,handles:{s:".clip-handle"},start:function(i,e){X.focus(),p("handle"),t=K.container.top,r=S().method,o=d().height},stop:function(i,e){u(),b()},resize:function(i,e){M(r,e.size.height,e.originalSize.height,t,o),b(),e.size.height=K.crop.height,void 0!==a&&a._trigger("cropheight",null,{value:K.crop.height})}}),E.find(".clip-handle").on("dblclick",function(i){return C(d().height),b(),!1}),j.draggable({scroll:!1,start:function(i,e){X.focus(),p("drag")},stop:function(i,e){b(),u()},drag:function(i,e){v(Math.round(e.position.left),Math.round(e.position.top),void 0,!1),e.position.left=K.container.left,e.position.top=K.container.top,b()}}).on("wheel",function(i){if(h.shiftWheel&&!i.shiftKey)return!0;var e=-i.originalEvent.deltaY;if(X.focus(),0!==e){p("wheel"),c=setTimeout(u,500);var t=d(),o=i.originalEvent.offsetX/t.width,r=i.originalEvent.offsetY/t.height,n=0<e?1.1*K.scale:K.scale/1.1;w(n,o,r),b()}return!1}).on("dblclick",function(i){return x(),!1}).on("click",function(i){var e;X.focus(),e="click",s?u():p(e)}),_.slider({min:Math.floor(z(K.minScale)),step:1,value:Math.round(z(K.scale)),max:Math.ceil(z(l())),slide:function(i,e){var t,o=(t=e.value,Math.pow(1.03,t)/100);w(o,void 0,void 0,!1),b(),e.value=z(K.scale)},start:function(){p("slide")},stop:function(){u()}}),Q(n).css("display","none"),X.css("display","inline"==$?"inline-block":$),X.removeClass("cropper-hidden"),X.focus(),void 0!==a&&a._trigger("copperready")},function(i){setTimeout(t)}),{getScale:function(){return K.scale},updateScale:w,getCropHeight:function(){return K.crop.Height},updateCropHeight:C,dispose:t}}(this.element.get(0),this.options,this)},scale:function(i){if(void 0===i)return this.options.instance.getScale();this.options.instance.updateScale(i)},cropHeight:function(i){if(void 0===i)return this.options.instance.getCropHeight();this.options.instance.updateCropHeight(i)},_destroy:function(){this.options.instance.dispose(!0)}})}(jQuery);
//# sourceMappingURL=jqueryui-mosaico-cropper.min.js.map